<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>QuackScript Web Shell + Docs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <style>
        body { font-family: 'Fira Mono', 'Roboto Mono', monospace; }
        #shell-output {
            min-height: 300px;
            max-height: 40vh;
            overflow-y: auto;
            background: #18181b;
            padding: 1em;
            border-radius: 0.5em;
            white-space: pre-wrap;
            word-break: break-word;
        }
        #docs-container {
            max-height: 70vh;
            overflow-y: auto;
            background: #212121;
            padding: 1.5rem;
            border-radius: 0.5em;
            color: #ddd;
        }
        #shell-input {
            background: #27272a;
            color: #f1f5f9;
            min-width: 250px;
        }
        .shell-prompt {
            color: #fde047;
            font-weight: bold;
        }
        .shell-result {
            color: #a7f3d0;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .shell-error {
            color: #fca5a5;
            white-space: pre-wrap;
            word-break: break-word;
        }

        #docs-container h1 {
            color: #f4d35e;
            font-weight: 800;
            font-size: 2.25rem;
            margin-bottom: 0.75rem;
        }
        #docs-container h2 {
            color: #fab005;
            font-weight: 700;
            font-size: 1.5rem;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 2px solid #fab005;
            padding-bottom: 0.25rem;
        }
        #docs-container h3 {
            color: #fcd34d;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.25rem;
        }
        #docs-container pre {
            background-color: #1e293b;
            border-radius: 0.375rem;
            padding: 0.75rem 1rem;
            overflow-x: auto;
            color: #93c5fd;
            margin-bottom: 1rem;
            font-family: 'Fira Mono', monospace;
            font-size: 0.9rem;
        }
        #docs-container code {
            background: #334155;
            padding: 0.1em 0.3em;
            border-radius: 0.25rem;
            font-family: 'Fira Mono', monospace;
            font-size: 0.9rem;
        }
        #docs-container p, #docs-container ul, #docs-container ol {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        #docs-container ul, #docs-container ol {
            padding-left: 1.25rem;
        }
        #docs-container a {
            color: #60a5fa;
            text-decoration: underline;
            transition: color 0.2s;
        }
        #docs-container a:hover {
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="md:col-span-2 bg-zinc-800 rounded-xl shadow-xl p-6 flex flex-col">
            <h1 class="text-3xl font-bold text-yellow-400 mb-4">QuackScript Web Shell</h1>

            <div class="mb-4">
                <label class="block font-bold text-gray-300 mb-1">Shell Output</label>
                <div id="shell-output" aria-live="polite" role="log" tabindex="0"></div>
            </div>

            <form id="shell-form" class="flex gap-2" autocomplete="off" aria-label="QuackScript Shell Input">
                <span class="shell-prompt" aria-hidden="true">quackscript &gt;</span>
                <input id="shell-input" type="text" aria-required="true" placeholder="Enter QuackScript command" autofocus spellcheck="false" />
                <button type="submit" class="bg-yellow-400 text-gray-900 px-4 py-2 font-bold rounded hover:bg-yellow-300">Run</button>
            </form>

            <div id="shell-loader" class="text-yellow-200 mt-2 hidden">Initializing Pyodide and QuackScript...</div>
        </div>
        <article id="docs-container" role="doc-article">
            <h1>QuackScript Documentation</h1>

            <h2>Introduction</h2>
            <p>QuackScript is a whimsical, duck-themed programming language with dynamic execution behavior. The language features a "duck mood" system that affects how your code runs, random weather events, and playful built-in functions.</p>

            <h2>Basic Syntax</h2>
            <h3>Variables</h3>
            <p>Declare variables using the <code>VAR</code> keyword:</p>
            <pre><code>VAR x = 10
VAR name = "Duck"
VAR myList = [1, 2, 3]</code></pre>

            <h3>Data Types</h3>
            <ul>
                <li><strong>Numbers</strong>: Integers and floats (e.g., 42, 3.14)</li>
                <li><strong>Strings</strong>: Text in double quotes, e.g., "Hello"</li>
                <li><strong>Lists</strong>: Collections in square brackets, e.g., [1, 2, 3]</li>
                <li><strong>Functions</strong>: Defined with <code>FUN</code> keyword</li>
                <li><strong>Eggs</strong>: Special values that hatch into functions</li>
            </ul>

            <h3>Comments</h3>
            <p>Use <code>#</code> for single-line comments:</p>
            <pre><code># This is a comment
VAR x = 5</code></pre>

            <h3>Operators</h3>
            <p><strong>Arithmetic</strong>: <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>^</code> (power)</p>
            <p><strong>Comparison</strong>: <code>==</code>, <code>!=</code>, <code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>, <code>&gt;=</code></p>
            <p><strong>Logical</strong>: <code>AND</code>, <code>OR</code>, <code>NOT</code></p>
            <p><strong>List Operations</strong>:</p>
            <ul>
                <li><code>list + item</code> - Append item to list</li>
                <li><code>list - index</code> - Remove item at index</li>
                <li><code>list * otherList</code> - Concatenate lists</li>
                <li><code>list / index</code> - Get item at index</li>
            </ul>

            <h2>Control Flow</h2>
            <h3>If Statements</h3>
            <p><strong>Single-line</strong>:</p>
            <pre><code>IF x > 10 THEN PRINT("Big") ELSE PRINT("Small")</code></pre>

            <p><strong>Multi-line</strong>:</p>
            <pre><code>IF x > 10 THEN
    PRINT("Big number")
    VAR y = x * 2
END</code></pre>

            <h3>Loops</h3>
            <p><strong>For Loop</strong>:</p>
            <pre><code>FOR i = 0 TO 10 THEN PRINT(i)</code></pre>

            <p><strong>While Loop</strong>:</p>
            <pre><code>VAR x = 0
WHILE x &lt; 10 THEN VAR x = x + 1</code></pre>

            <p><strong>Loop Control</strong>:</p>
            <ul>
                <li><code>CONTINUE</code> - Skip to next iteration</li>
                <li><code>BREAK</code> - Exit loop</li>
            </ul>

            <h2>Functions</h2>
            <h3>Function Definition</h3>
            <p><strong>Single-line (arrow syntax)</strong>:</p>
            <pre><code>FUN add(a, b) -&gt; a + b</code></pre>

            <p><strong>Multi-line</strong>:</p>
            <pre><code>FUN greet(name)
    VAR message = "Hello, " + name
    PRINT(message)
    RETURN message
END</code></pre>

            <h2>Built-in Functions</h2>
            <h3>I/O Functions</h3>
            <ul>
                <li><code>PRINT(value)</code> - Print value</li>
                <li><code>PRINT_RET(value)</code> - Return value as string</li>
                <li><code>INPUT()</code> - Read string input</li>
                <li><code>INPUT_INT()</code> - Read integer input</li>
                <li><code>CLEAR()</code> / <code>CLS()</code> - Clear screen</li>
            </ul>

            <h3>Type Checking</h3>
            <ul>
                <li><code>IS_NUM(value)</code> - Check if number</li>
                <li><code>IS_STR(value)</code> - Check if string</li>
                <li><code>IS_LIST(value)</code> - Check if list</li>
                <li><code>IS_FUN(value)</code> - Check if function</li>
            </ul>

            <h3>List Functions</h3>
            <ul>
                <li><code>APPEND(list, value)</code> - Add item to list</li>
                <li><code>POP(list, index)</code> - Remove and return item</li>
                <li><code>EXTEND(listA, listB)</code> - Add all items from listB to listA</li>
                <li><code>LEN(list)</code> - Get list length</li>
            </ul>

            <h3>Duck-Themed Functions</h3>
            <ul>
                <li><code>QUACK()</code> - Animated duck walks across screen and quacks</li>
                <li><code>FLAP()</code> - Print flapping message</li>
                <li><code>MOOD()</code> - Get current duck mood and weather</li>
                <li><code>EGG(func, time)</code> - Create egg that hatches after <code>time</code> seconds</li>
                <li><code>HATCH(egg)</code> - Hatch egg to get function inside</li>
            </ul>

            <h3>Constants</h3>
            <ul>
                <li><code>NULL</code> - Null value (0)</li>
                <li><code>TRUE</code> - Boolean true (1)</li>
                <li><code>FALSE</code> - Boolean false (0)</li>
                <li><code>MATH_PI</code> - Pi constant (3.14159...)</li>
            </ul>

            <h2>Examples</h2>
            <h3>Factorial Function</h3>
            <pre>FUN factorial(n)
    IF n &lt;= 1 THEN
        RETURN 1
    ELSE
        RETURN n * factorial(n - 1)
    END
END

PRINT(factorial(5))</pre>

            <h3>List Processing</h3>
            <pre>VAR numbers = [1, 2, 3, 4, 5]
VAR sum = 0

FOR i = 0 TO LEN(numbers) THEN
    VAR sum = sum + (numbers / i)
END

PRINT(sum)</pre>
        </article>
    </div>

    <script>
        let pyodide, quackLoaded = false;
        const VFS = {};

        function appendOutput(html, cls) {
            const outputDiv = document.getElementById("shell-output");
            const span = document.createElement("span");
            span.className = cls || "";
            span.innerHTML = html;
            outputDiv.appendChild(span);
            outputDiv.appendChild(document.createElement("br"));
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }

        async function loadQuackScriptFiles() {
            async function fetchFile(name) {
                const resp = await fetch(name);
                if (!resp.ok) throw new Error("Failed to fetch: " + name);
                return await resp.text();


            }
            return {
                "quackscript.py": await fetchFile("quackscript.py"),
                "strings_with_arrows.py": await fetchFile("strings_with_arrows.py"),
            };
        }

        async function initPyodideAndQuackScript() {
            document.getElementById("shell-loader").classList.remove("hidden");
            pyodide = await loadPyodide({
                indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/",
            });
            const rawfiles = await loadQuackScriptFiles();
            pyodide.FS.writeFile("quackscript.py", rawfiles["quackscript.py"]);
            pyodide.FS.writeFile("strings_with_arrows.py", rawfiles["strings_with_arrows.py"]);
            await pyodide.runPythonAsync("import sys; sys.path.append('.')");
            quackLoaded = true;
            document.getElementById("shell-loader").classList.add("hidden");
            appendOutput("QuackScript Web Shell ready. Type some commands!", "text-green-300");
        }

        async function handleShellCommand(command) {
            if (!quackLoaded) {
                appendOutput("Interpreter not ready yet.", "shell-error");
                return;
            }
            if (!command.trim()) return;
            
            let runFileMatch = command.match(/RUN\s*\(\s*["'](.+?)["']\s*\)/i);
            if (runFileMatch) {
                let filename = runFileMatch[1];
                let scriptCode = VFS[filename];
                if (!scriptCode) {
                    appendOutput("File '" + filename + "' not found in session.", "shell-error");
                    return;
                }
                command = scriptCode;
            }
            
            try {
                let escapedCommand = command.replace(/\\/g, "\\\\").replace(/'/g, "\\'");
                let pyShellCode = `
import quackscript
import sys
from io import StringIO

old_stdout = sys.stdout
sys.stdout = captured_output = StringIO()

text = '''${escapedCommand}'''
result, error = quackscript.run('<stdin>', text)

sys.stdout = old_stdout
printed_output = captured_output.getvalue()

output = ""
if error:
    output = error.as_string()
else:
    if printed_output:
        output = printed_output
    elif result:
        try:
            if hasattr(result, "elements") and len(result.elements) == 1:
                elem = result.elements[0]
                if repr(elem) != "0":  # Don't show null return values
                    output = repr(elem)
            else:
                if repr(result) != "0":
                    output = repr(result)
        except Exception as ex:
            output = "Result formatting error: " + str(ex)
output
`;
                let pyresult = await pyodide.runPythonAsync(pyShellCode);
                if (pyresult) {
                    pyresult = pyresult
                        .replace(/\033\[91m/g, '<span style="color:#fca5a5">')
                        .replace(/\033\[92m/g, '<span style="color:#86efac">')
                        .replace(/\033\[93m/g, '<span style="color:#fde047">')
                        .replace(/\033\[94m/g, '<span style="color:#93c5fd">')
                        .replace(/\033\[95m/g, '<span style="color:#e9d5ff">')
                        .replace(/\033\[96m/g, '<span style="color:#a5f3fc">')
                        .replace(/\033\[0m/g, '</span>')
                        .replace(/\[91m/g, '<span style="color:#fca5a5">')
                        .replace(/\[92m/g, '<span style="color:#86efac">')
                        .replace(/\[93m/g, '<span style="color:#fde047">')
                        .replace(/\[94m/g, '<span style="color:#93c5fd">')
                        .replace(/\[95m/g, '<span style="color:#e9d5ff">')
                        .replace(/\[96m/g, '<span style="color:#a5f3fc">')
                        .replace(/\[0m/g, '</span>');
                    
                    if (pyresult.startsWith("Illegal Character:") || 
                        pyresult.startsWith("Invalid Syntax:") || 
                        pyresult.startsWith("Runtime Error:")) {
                        appendOutput(pyresult, "shell-error");
                    } else {
                        appendOutput(pyresult, "shell-result");
                    }
                }
            } catch (err) {
                appendOutput("Python error: " + err, "shell-error");
            }
        }

        document.getElementById("shell-form").addEventListener("submit", async function(e) {
            e.preventDefault();
            const inp = document.getElementById("shell-input");
            const cmd = inp.value;
            appendOutput('<span class="shell-prompt">quackscript &gt; </span>' + cmd);
            inp.value = "";
            await handleShellCommand(cmd);
        });

        window.onload = initPyodideAndQuackScript;
    </script>
</body>
</html>